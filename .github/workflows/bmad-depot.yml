nname: VibeLayer BMAD-Depot Development Pipeline

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - coordinate-development
          - spawn-single-agent
          - monitor-sessions
          - cleanup-sessions
        
      story_file:
        description: 'Story file path (for spawn-single-agent)'
        required: false
        default: ''
      story_id:
        description: 'Story identifier (optional)'
        required: false
        default: ''
      max_concurrent:
        description: 'Maximum concurrent development agents'
        required: false
        default: '5'
      stories_dir:
        description: 'Stories directory path (optional)'
        required: false
        default: ''

  push:
    paths:
      - '.bmad/stories/**/*.md'
      - 'stories/**/*.md'
    branches:
      - main
      - develop

  pull_request:
    paths:
      - '.bmad/stories/**/*.md' 
      - 'stories/**/*.md'

concurrency:
  group: bmad-depot-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: false

jobs:
  validate-environment:
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.validate.outputs.proceed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Depot
        uses: depot/setup-action@v1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate environment
        id: validate
        run: |
          echo "🔍 Validating BMAD-Depot environment..."
          
          # Check for required directories
          if [ ! -d "scripts/depot" ]; then
            echo "❌ scripts/depot directory not found"
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check for required scripts
          if [ ! -f "scripts/depot/bmad_depot_bridge.py" ]; then
            echo "❌ BMAD-Depot bridge script not found"
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Make scripts executable
          chmod +x scripts/depot/*.py 2>/dev/null || true
          
          echo "✅ Environment validation passed"
          echo "proceed=true" >> $GITHUB_OUTPUT

  execute-bmad-depot-action:
    needs: validate-environment
    if: needs.validate-environment.outputs.proceed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    outputs:
      action_success: ${{ steps.bmad_action.outputs.action_success }}
      result_status: ${{ steps.bmad_action.outputs.result_status }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Depot
        uses: depot/setup-action@v1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Configure Depot Authentication
        env:
          DEPOT_TOKEN: ${{ secrets.DEPOT_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          if [ -z "$DEPOT_TOKEN" ]; then
            echo "❌ DEPOT_TOKEN secret not configured"
            exit 1
          fi
          
          # Configure depot with token
          mkdir -p ~/.depot
          echo "$DEPOT_TOKEN" > ~/.depot/token
          
          if [ -n "$CLAUDE_CODE_OAUTH_TOKEN" ]; then
            echo "✅ Claude Code OAuth token configured"
            echo "$CLAUDE_CODE_OAUTH_TOKEN" > ~/.depot/claude_token
          else
            echo "⚠️  Claude Code OAuth token not configured - some features may not work"
          fi

      - name: Execute BMAD-Depot Action
        id: bmad_action
        env:
          ACTION: ${{ github.event.inputs.action || 'coordinate-development' }}
          STORY_FILE: ${{ github.event.inputs.story_file }}
          STORY_ID: ${{ github.event.inputs.story_id }}
          MAX_CONCURRENT: ${{ github.event.inputs.max_concurrent || '5' }}
          STORIES_DIR: ${{ github.event.inputs.stories_dir }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          DEPOT_TOKEN: ${{ secrets.DEPOT_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "🚀 Executing BMAD-Depot action: $ACTION"
          
          # Make scripts executable
          chmod +x scripts/depot/*.py 2>/dev/null || true
          
          # Create output directory
          mkdir -p .depot/{sessions,logs,artifacts}
          
          # Determine command based on action
          case "$ACTION" in
            "coordinate-development")
              echo "📦 Coordinating parallel development..."
              if [ -n "$STORIES_DIR" ]; then
                python3 scripts/depot/bmad_depot_bridge.py coordinate \
                  --stories-dir "$STORIES_DIR" \
                  --max-concurrent "$MAX_CONCURRENT" > action_result.json 2>&1
              else
                python3 scripts/depot/bmad_depot_bridge.py coordinate \
                  --max-concurrent "$MAX_CONCURRENT" > action_result.json 2>&1
              fi
              ;;
            "spawn-single-agent")
              if [ -z "$STORY_FILE" ]; then
                echo "❌ Story file required for spawn-single-agent action"
                exit 1
              fi
              echo "🤖 Spawning development agent for story: $STORY_FILE"
              if [ -n "$STORY_ID" ]; then
                python3 scripts/depot/bmad_depot_bridge.py spawn-dev \
                  --story-file "$STORY_FILE" \
                  --story-id "$STORY_ID" > action_result.json 2>&1
              else
                python3 scripts/depot/bmad_depot_bridge.py spawn-dev \
                  --story-file "$STORY_FILE" > action_result.json 2>&1
              fi
              ;;
            "monitor-sessions")
              echo "📊 Monitoring active development sessions..."
              python3 scripts/depot/bmad_depot_bridge.py monitor \
                --timeout 15 > action_result.json 2>&1
              ;;
            "cleanup-sessions")
              echo "🧹 Cleaning up old sessions..."
              python3 scripts/depot/bmad_depot_bridge.py cleanup > action_result.json 2>&1
              ;;
            *)
              echo "❌ Unknown action: $ACTION"
              exit 1
              ;;
          esac
          
          # Check if action succeeded
          if [ $? -eq 0 ]; then
            echo "✅ Action completed successfully"
            echo "result_status=success" >> $GITHUB_OUTPUT
          else
            echo "❌ Action failed"
            echo "result_status=failure" >> $GITHUB_OUTPUT
          fi
          
          # Extract key information from result
          if [ -f "action_result.json" ]; then
            # Check if jq is available, install if not
            if ! command -v jq >/dev/null 2>&1; then
              echo "Installing jq..."
              sudo apt-get update && sudo apt-get install -y jq
            fi
            
            cat action_result.json | jq '.' || cat action_result.json
            
            # Extract summary information
            if command -v jq >/dev/null 2>&1; then
              SUCCESS=$(jq -r '.success // false' action_result.json 2>/dev/null || echo "false")
              MESSAGE=$(jq -r '.message // "No message"' action_result.json 2>/dev/null || echo "No message")
              
              echo "action_success=$SUCCESS" >> $GITHUB_OUTPUT
              echo "action_message=$MESSAGE" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bmad-depot-results-${{ github.run_number }}
          path: |
            action_result.json
            .depot/sessions/*.json
            .depot/logs/*.log
          retention-days: 30
          if-no-files-found: warn

      - name: Create Job Summary
        if: always()
        run: |
          echo "# 🌉 BMAD-Depot Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action || 'coordinate-development' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.bmad_action.outputs.result_status || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "action_result.json" ]; then
            echo "**Results:**" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat action_result.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request' && steps.bmad_action.outputs.action_success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let resultContent = "## 🌉 BMAD-Depot Development Results\n\n";
            
            if (fs.existsSync('action_result.json')) {
              try {
                const result = JSON.parse(fs.readFileSync('action_result.json', 'utf8'));
                
                resultContent += `**Action:** ${{ github.event.inputs.action || 'coordinate-development' }}\n`;
                resultContent += `**Status:** ${result.success ? '✅ Success' : '❌ Failed'}\n`;
                resultContent += `**Message:** ${result.message || 'No message'}\n\n`;
                
                if (result.coordination_result) {
                  resultContent += `**Sessions Spawned:** ${result.coordination_result.sessions_spawned || 0}\n`;
                  resultContent += `**Total Stories:** ${result.coordination_result.total_stories || 0}\n`;
                }
                
                resultContent += `\n<details><summary>Full Results</summary>\n\n\`\`\`json\n${JSON.stringify(result, null, 2)}\n\`\`\`\n</details>`;
              } catch (e) {
                console.error('Failed to parse action_result.json:', e);
                resultContent += "**Error:** Failed to parse results\n";
              }
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: resultContent
            });

  depot-docker-build:
    needs: [validate-environment, execute-bmad-depot-action]
    if: |
      always() && 
      needs.execute-bmad-depot-action.outputs.action_success == 'true' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Depot
        uses: depot/setup-action@v1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push Docker image with Depot
        uses: depot/build-push-action@v1
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          project: ${{ secrets.DEPOT_PROJECT_ID }}

  notify-completion:
    needs: [validate-environment, execute-bmad-depot-action]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Workflow Summary
        run: |
          echo "🔔 BMAD-Depot Pipeline Completed"
          echo "Action: ${{ github.event.inputs.action || 'coordinate-development' }}"
          echo "Status: ${{ needs.execute-bmad-depot-action.result }}"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          
      - name: Send notification (if configured)
        if: failure() && vars.SLACK_WEBHOOK_URL
        run: |
          curl -X POST ${{ vars.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "BMAD-Depot Pipeline Failed",
              "blocks": [{
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Pipeline Failed* :x:\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Action:* ${{ github.event.inputs.action || 'coordinate-development' }}"
                }
              }]
            }'