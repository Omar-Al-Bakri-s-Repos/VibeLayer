# Story 1.6: Essential Safety Controls & Emergency Systems

## Status: Draft
**Priority:** 1 (Critical - Safety)
**Depends On:** Story 1.1 (needs infrastructure)

## Story Statement
**As a** creator,
**I want** immediate control to stop all effects if something goes wrong,
**So that** I can maintain professional stream quality and handle unexpected situations.

## Acceptance Criteria
1. ✅ Prominent panic button in control panel stops all active effects within 200ms
2. ✅ Hotkey support (configurable, default: Ctrl+Shift+P) for panic activation
3. ✅ 10-second effect lockout period after panic activation prevents immediate retriggering
4. ✅ Undo functionality available for 5 seconds after panic or manual activation
5. ✅ Effect pause/resume controls for temporary deactivation without full panic
6. ✅ Visual feedback confirms panic activation and system status clearly

## Dev Notes

### Epic Context  
This story provides critical safety mechanisms that give creators confidence to use AI-driven effects. Without these controls, creators won't trust the system during live streams. This is essential for professional streamers who need fail-safes.

### Story Dependencies
- **Depends On:** Story 1.1 (basic infrastructure)
- **Blocks:** None - safety features can be used by all other stories
- **Parallel Potential:** Can be developed alongside any other story except 1.1

### Technical Architecture

#### Safety System Design
```typescript
interface SafetySystem {
  panicActive: boolean;
  lockoutEndTime: Date | null;
  pausedEffects: string[];
  undoStack: UndoAction[];
  hotkeyBindings: HotkeyConfig;
}

interface PanicMessage extends WSMessage {
  type: 'panic';
  payload: {
    action: 'activate' | 'deactivate';
    source: 'button' | 'hotkey' | 'auto';
    timestamp: Date;
  };
}

interface UndoAction {
  effectId: string;
  timestamp: Date;
  expiresAt: Date;  // 5 seconds after activation
}
```

#### Response Time Requirements
- Panic activation: <200ms from trigger to all effects stopped
- Network broadcast: Immediate WebSocket message to all clients
- UI update: <50ms visual feedback
- Undo window: 5000ms availability

### Implementation Tasks

#### Task 1: Create Panic Button UI
- [ ] Design prominent red panic button component
- [ ] Add to control panel header (always visible)
- [ ] Implement click handler with confirmation
- [ ] Add visual states (normal, hover, active, locked)
- [ ] Create animated feedback on activation

#### Task 2: Implement Hotkey System
- [ ] Create hotkey binding service
- [ ] Set up default binding (Ctrl+Shift+P)
- [ ] Add hotkey configuration UI
- [ ] Handle cross-platform key differences
- [ ] Prevent conflicts with browser shortcuts

#### Task 3: Build Panic Activation Logic
- [ ] Create panic state management in Zustand
- [ ] Implement WebSocket panic message handler
- [ ] Stop all active effects immediately
- [ ] Clear effect queue and suggestions
- [ ] Broadcast panic state to all components

#### Task 4: Add Lockout Period
- [ ] Implement 10-second lockout timer
- [ ] Prevent new effect triggers during lockout
- [ ] Show countdown timer in UI
- [ ] Allow manual override by creator
- [ ] Log lockout events for analysis

#### Task 5: Create Undo System
- [ ] Build undo stack for recent actions
- [ ] Implement 5-second expiration timer
- [ ] Add undo button near effects
- [ ] Create undo hotkey (Ctrl+Z)
- [ ] Show undo availability indicator

#### Task 6: Implement Pause/Resume
- [ ] Add pause button to control panel
- [ ] Create paused state management
- [ ] Queue effects while paused
- [ ] Implement resume with queued effects
- [ ] Add pause duration tracking

#### Task 7: Add Visual Feedback
- [ ] Create panic mode overlay
- [ ] Add status bar indicators
- [ ] Implement toast notifications
- [ ] Show system state clearly
- [ ] Add sound effects (optional)

#### Task 8: Build Auto-Recovery
- [ ] Detect system anomalies
- [ ] Auto-trigger panic on errors
- [ ] Implement graceful recovery
- [ ] Log safety events
- [ ] Create incident reports

### File Locations
- Safety components: `/apps/control-panel/src/components/safety/`
- Panic button: `/apps/control-panel/src/components/safety/PanicButton.tsx`
- Hotkey service: `/apps/control-panel/src/services/hotkeys/`
- Safety state: `/apps/control-panel/src/stores/safety.ts`
- WebSocket handlers: `/apps/api-services/src/websocket/handlers/safety.ts`

### Testing Requirements
- Unit tests for panic activation logic
- Integration tests for WebSocket communication
- Response time benchmarks (<200ms)
- Hotkey functionality tests
- Undo system tests
- UI interaction tests
- Stress tests under high load

### Technical Constraints
- Panic response time <200ms
- Lockout period exactly 10 seconds
- Undo window exactly 5 seconds
- Hotkeys must work when window not focused
- Must work offline (local panic)
- No external dependencies for safety

## Definition of Done
- [ ] Panic button prominently displayed
- [ ] Hotkey system implemented and configurable
- [ ] Panic stops all effects within 200ms
- [ ] Lockout period enforced
- [ ] Undo functionality working
- [ ] Pause/resume controls operational
- [ ] Visual feedback clear and immediate
- [ ] Auto-recovery system active
- [ ] Tests passing with timing validation
- [ ] Safety documentation created