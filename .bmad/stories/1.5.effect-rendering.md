# Story 1.5: Basic Effect Rendering & Web Overlay System

## Status: Draft
**Priority:** 2 (Core Feature)
**Depends On:** Stories 1.1, 1.2, 1.4 (needs infrastructure, WebSocket, and intent classifications)

## Story Statement
**As a** desktop streamer,
**I want** visual effects to render smoothly in my streaming software,
**So that** I can enhance my stream with conversation-aware visuals.

## Acceptance Criteria
1. ✅ WebGL-based effect rendering engine with Lottie integration for complex animations
2. ✅ Premultiplied alpha support ensures proper compositing in OBS/streaming software
3. ✅ Effect library with 5-10 foundational effects covering core intent categories
4. ✅ Deterministic rendering with identical seeds produces consistent visual output
5. ✅ Performance monitoring achieves 60fps target with graceful degradation to 30fps
6. ✅ Signed overlay URLs with JWT tokens prevent unauthorized access

## Dev Notes

### Epic Context
This story delivers the visual output that creators see - the actual effects rendered on their streams. It consumes intent classifications from Story 1.4 and renders effects that overlay on streaming software. This is the most visible feature to end users.

### Story Dependencies
- **Depends On:** Stories 1.1, 1.2, 1.4 (infrastructure, WebSocket, intents)
- **Blocks:** Story 1.7 (control panel needs to preview effects)
- **Parallel Potential:** Can work alongside Stories 1.3, 1.6, 1.8

### Technical Architecture

#### Rendering Stack
- **Web:** WebGL 2.0 with Three.js for 3D effects
- **Animations:** Lottie-web for complex 2D animations
- **Compositing:** Premultiplied alpha for OBS/Streamlabs
- **Format:** Browser source URL with transparent background

#### Effect System Architecture
```typescript
interface Effect {
  id: string;
  name: string;
  category: 'celebration' | 'hype' | 'emotion' | 'ambient';
  renderType: 'webgl' | 'lottie' | 'css' | 'canvas';
  duration: number;  // milliseconds
  assets: AssetReference[];
  parameters: EffectParameters;
}

interface RenderParameters {
  seed: number;  // For deterministic rendering
  intensity: number;  // 0-1 effect strength
  color?: string;  // Brand color override
  position?: Position;  // Screen position
}
```

### Implementation Tasks

#### Task 1: Set Up WebGL Rendering Engine
- [ ] Create packages/effects-engine/src/renderer/
- [ ] Initialize Three.js with WebGL 2.0 context
- [ ] Set up transparent rendering pipeline
- [ ] Configure premultiplied alpha blending
- [ ] Create render loop with RAF

#### Task 2: Implement Lottie Integration
- [ ] Install and configure lottie-web
- [ ] Create Lottie effect loader
- [ ] Build animation controller
- [ ] Add playback speed control
- [ ] Implement color customization

#### Task 3: Create Base Effect Library
- [ ] Celebration: Confetti burst (WebGL particles)
- [ ] Win: Trophy appearance (Lottie animation)
- [ ] Hype: Energy waves (WebGL shader)
- [ ] Gratitude: Heart float (Lottie + WebGL)
- [ ] Romance: Rose petals (WebGL particles)
- [ ] Loss: Rain effect (WebGL shader)
- [ ] Ambient: Subtle glow (CSS animations)

#### Task 4: Build Overlay System
- [ ] Create overlay route in control panel
- [ ] Implement transparent background
- [ ] Add OBS browser source compatibility
- [ ] Create URL parameter system
- [ ] Implement JWT signing for security

#### Task 5: Add Performance Monitoring
- [ ] Implement FPS counter
- [ ] Create performance profiler
- [ ] Add automatic quality reduction
- [ ] Monitor GPU usage
- [ ] Log performance metrics

#### Task 6: Implement Deterministic Rendering
- [ ] Create seeded random number generator
- [ ] Ensure particle systems use seeds
- [ ] Make animations reproducible
- [ ] Add seed to render parameters
- [ ] Test determinism across browsers

#### Task 7: Create Asset Management
- [ ] Set up CDN for effect assets
- [ ] Implement asset preloading
- [ ] Add progressive loading
- [ ] Create asset versioning
- [ ] Optimize asset sizes

#### Task 8: Build Effect Preview System
- [ ] Create preview component for control panel
- [ ] Add effect parameter controls
- [ ] Implement real-time preview
- [ ] Create effect gallery view
- [ ] Add search and filtering

### File Locations
- Rendering engine: `/packages/effects-engine/src/renderer/`
- Effect definitions: `/packages/effects-engine/src/effects/`
- Assets: `/packages/effects-engine/assets/`
- Overlay route: `/apps/control-panel/src/app/overlay/`
- Preview components: `/apps/control-panel/src/components/effects/`

### Testing Requirements
- Unit tests for rendering logic
- Visual regression tests for effects
- Performance benchmarks (60fps target)
- Browser compatibility tests
- OBS integration tests
- Load tests with multiple effects
- Determinism validation tests

### Technical Constraints
- Must maintain 60fps on modern GPUs
- Graceful degradation to 30fps on older hardware
- Maximum effect duration: 10 seconds
- Asset size limit: 5MB per effect
- Support Chrome, Firefox, Edge browsers
- Transparent background required for OBS

## Definition of Done
- [ ] WebGL rendering engine operational
- [ ] Lottie animations integrated
- [ ] 7+ effects implemented and tested
- [ ] Overlay URL system working
- [ ] OBS browser source compatible
- [ ] Performance monitoring active
- [ ] Deterministic rendering verified
- [ ] JWT security implemented
- [ ] Effect preview in control panel
- [ ] Documentation and examples created